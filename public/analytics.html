<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analytics - StockSense</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Analytics & Insights</h1>
    </div>

    <div class="content" style="padding-bottom: 80px;">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="total-revenue">‚Ç±0</div>
          <div class="stat-label">Revenue (30 days)</div>
        </div>

        <div class="stat-card secondary">
          <div class="stat-value" id="total-sales">0</div>
          <div class="stat-label">Sales (30 days)</div>
        </div>

        <div class="stat-card success">
          <div class="stat-value" id="avg-order">‚Ç±0</div>
          <div class="stat-label">Avg Order</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3 class="card-title">ü§ñ AI Insights</h3>
          <span class="badge badge-primary">Powered by ML</span>
        </div>
        <div id="ai-insights">
          <div class="loading">
            <div class="spinner"></div>
            <p>Analyzing data...</p>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3 class="card-title">üìà Sales Trend</h3>
          <span style="font-size: 12px; color: #6c757d;">Last 30 days</span>
        </div>
        <div class="chart-container">
          <canvas id="sales-trend-chart"></canvas>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3 class="card-title">üí∞ Revenue by Category</h3>
        </div>
        <div class="chart-container">
          <canvas id="revenue-chart"></canvas>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3 class="card-title">üèÜ Top 10 Products</h3>
        </div>
        <div id="top-products">
          <div class="loading">
            <div class="spinner"></div>
            <p>Loading data...</p>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3 class="card-title">üîÆ AI Predictions & Recommendations</h3>
          <span class="badge" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            Smart Analysis
          </span>
        </div>
        <div id="predictions">
          <div class="loading">
            <div class="spinner"></div>
            <p>Generating predictions...</p>
          </div>
        </div>
      </div>
    </div>

    <div class="bottom-nav">
      <button class="nav-item" onclick="location.href='home.html'">
        <span class="icon">üè†</span>
        <span class="label">Home</span>
      </button>
      <button class="nav-item" onclick="location.href='stocks.html'">
        <span class="icon">üì¶</span>
        <span class="label">Stocks</span>
      </button>
      <button class="nav-item" onclick="location.href='sales.html'">
        <span class="icon">üõí</span>
        <span class="label">Sales</span>
      </button>
      <button class="nav-item active">
        <span class="icon">üìä</span>
        <span class="label">Analytics</span>
      </button>
      <button class="nav-item" onclick="logout()">
        <span class="icon">üö™</span>
        <span class="label">Logout</span>
      </button>
    </div>
  </div>

  <script>
    let salesTrendChart, revenueChart;

    async function checkAuth() {
      try {
        const response = await fetch('/api/user');
        if (!response.ok) {
          window.location.href = 'index.html';
          return;
        }
        const user = await response.json();
        if (user.role !== 'Manager' && user.role !== 'Admin') {
          window.location.href = 'index.html';
        }
      } catch (error) {
        window.location.href = 'index.html';
      }
    }

    async function loadAnalytics() {
      try {
        // Load sales trend
        const trendResponse = await fetch('/api/analytics/sales-trend');
        const trendData = await trendResponse.json();

        // Load category breakdown
        const categoryResponse = await fetch('/api/analytics/category-breakdown');
        const categoryData = await categoryResponse.json();

        // Load top products
        const topProductsResponse = await fetch('/api/analytics/top-products');
        const topProducts = await topProductsResponse.json();

        // Calculate stats
        const totalRevenue = trendData.reduce((sum, day) => sum + (day.revenue || 0), 0);
        const totalSales = trendData.reduce((sum, day) => sum + (day.sales_count || 0), 0);
        const avgOrder = totalSales > 0 ? totalRevenue / totalSales : 0;

        document.getElementById('total-revenue').textContent = `‚Ç±${totalRevenue.toFixed(2)}`;
        document.getElementById('total-sales').textContent = totalSales;
        document.getElementById('avg-order').textContent = `‚Ç±${avgOrder.toFixed(2)}`;

        // Generate AI insights
        generateAIInsights(trendData, categoryData, topProducts);

        // Create charts
        createSalesTrendChart(trendData);
        createRevenueChart(categoryData);

        // Display top products
        displayTopProducts(topProducts);

        // Load predictions
        loadPredictions();
      } catch (error) {
        console.error('Error loading analytics:', error);
      }
    }

    function generateAIInsights(trendData, categoryData, topProducts) {
      const container = document.getElementById('ai-insights');
      const insights = [];

      // Trend analysis
      if (trendData.length >= 7) {
        const recentWeek = trendData.slice(-7);
        const previousWeek = trendData.slice(-14, -7);
        
        const recentRevenue = recentWeek.reduce((sum, d) => sum + (d.revenue || 0), 0);
        const previousRevenue = previousWeek.reduce((sum, d) => sum + (d.revenue || 0), 0);
        
        const change = previousRevenue > 0 ? ((recentRevenue - previousRevenue) / previousRevenue * 100) : 0;
        
        if (change > 0) {
          insights.push(`üìà <strong>Sales are trending up!</strong> Revenue increased by ${change.toFixed(1)}% compared to last week.`);
        } else if (change < -5) {
          insights.push(`üìâ <strong>Sales declined by ${Math.abs(change).toFixed(1)}%</strong> this week. Consider promotional activities.`);
        } else {
          insights.push(`üìä Sales are stable. Revenue changed by ${change.toFixed(1)}% from last week.`);
        }
      }

      // Best category
      if (categoryData.length > 0) {
        const bestCategory = categoryData[0];
        insights.push(`üèÜ <strong>${bestCategory.category}</strong> is your top performing category with ‚Ç±${bestCategory.revenue.toFixed(2)} in revenue.`);
      }

      // Top product
      if (topProducts.length > 0) {
        const topProduct = topProducts[0];
        insights.push(`‚≠ê <strong>${topProduct.name}</strong> is your best seller with ${topProduct.total_sold} units sold.`);
      }

      // Stock alert
      insights.push(`‚ö†Ô∏è Monitor inventory levels regularly to avoid stockouts and maintain optimal service.`);

      container.innerHTML = insights.map((insight, i) => `
        <div style="padding: 12px; margin-bottom: 8px; background: ${i === 0 ? '#e7f3ff' : '#f8f9fa'}; border-radius: 8px; border-left: 4px solid ${i === 0 ? '#667eea' : '#dee2e6'};">
          <p style="font-size: 14px; line-height: 1.6; margin: 0;">${insight}</p>
        </div>
      `).join('');
    }

    function createSalesTrendChart(data) {
      const ctx = document.getElementById('sales-trend-chart').getContext('2d');
      
      if (salesTrendChart) {
        salesTrendChart.destroy();
      }

      const dates = data.map(d => {
        const date = new Date(d.date);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      });
      
      const revenues = data.map(d => d.revenue || 0);

      salesTrendChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: dates,
          datasets: [{
            label: 'Revenue (‚Ç±)',
            data: revenues,
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return '‚Ç±' + value;
                }
              }
            }
          }
        }
      });
    }

    function createRevenueChart(data) {
      const ctx = document.getElementById('revenue-chart').getContext('2d');
      
      if (revenueChart) {
        revenueChart.destroy();
      }

      const colors = [
        '#667eea', '#764ba2', '#f093fb', '#4facfe', 
        '#43e97b', '#fa709a', '#fee140', '#30cfd0'
      ];

      revenueChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.map(d => d.category),
          datasets: [{
            label: 'Revenue',
            data: data.map(d => d.revenue || 0),
            backgroundColor: colors.slice(0, data.length)
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return '‚Ç±' + value;
                }
              }
            }
          }
        }
      });
    }

    function displayTopProducts(products) {
      const container = document.getElementById('top-products');
      
      if (products.length === 0) {
        container.innerHTML = '<div class="empty-state"><p style="padding: 20px;">No sales data available</p></div>';
        return;
      }

      container.innerHTML = products.map((product, index) => `
        <div class="product-item">
          <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
            <div style="width: 32px; height: 32px; background: ${index < 3 ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : '#e9ecef'}; color: ${index < 3 ? 'white' : '#6c757d'}; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;">
              ${index + 1}
            </div>
            <div class="product-info">
              <h4>${product.name}</h4>
              <p>${product.sku} ‚Ä¢ ${product.total_sold} units sold</p>
            </div>
          </div>
          <div class="product-price">‚Ç±${product.revenue.toFixed(2)}</div>
        </div>
      `).join('');
    }

    async function loadPredictions() {
      try {
        const response = await fetch('/api/analytics/predictions');
        const predictions = await response.json();

        const container = document.getElementById('predictions');
        
        // Group by priority
        const critical = predictions.filter(p => p.priority === 'critical');
        const high = predictions.filter(p => p.priority === 'high');
        const medium = predictions.filter(p => p.priority === 'medium');

        let html = '';

        if (critical.length > 0) {
          html += `
            <div style="margin-bottom: 16px;">
              <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 8px; color: #dc3545;">
                üö® Critical Priority (${critical.length})
              </h4>
              ${critical.map(p => `
                <div style="padding: 12px; margin-bottom: 8px; background: #f8d7da; border-radius: 8px; border-left: 4px solid #dc3545;">
                  <p style="font-weight: 600; margin-bottom: 4px;">${p.name}</p>
                  <p style="font-size: 13px; color: #721c24; margin: 0;">${p.action}</p>
                  <p style="font-size: 12px; margin-top: 4px; color: #721c24;">Recommend ordering: ${p.recommendedOrder} units</p>
                </div>
              `).join('')}
            </div>
          `;
        }

        if (high.length > 0) {
          html += `
            <div style="margin-bottom: 16px;">
              <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 8px; color: #ffc107;">
                ‚ö†Ô∏è High Priority (${high.length})
              </h4>
              ${high.slice(0, 5).map(p => `
                <div style="padding: 12px; margin-bottom: 8px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                  <p style="font-weight: 600; margin-bottom: 4px;">${p.name}</p>
                  <p style="font-size: 13px; color: #856404; margin: 0;">${p.action}</p>
                  <p style="font-size: 12px; margin-top: 4px; color: #856404;">Selling ${p.soldPerDay} units/day ‚Ä¢ ${p.daysUntilStockout} days until stockout</p>
                </div>
              `).join('')}
            </div>
          `;
        }

        if (medium.length > 0) {
          html += `
            <div>
              <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 8px; color: #17a2b8;">
                ‚ÑπÔ∏è Medium Priority (${medium.length})
              </h4>
              <p style="font-size: 13px; color: #6c757d; margin-bottom: 8px;">
                These items should be monitored. Consider restocking within the next 2-3 weeks.
              </p>
              ${medium.slice(0, 3).map(p => `
                <div style="padding: 12px; margin-bottom: 8px; background: #d1ecf1; border-radius: 8px; border-left: 4px solid #17a2b8;">
                  <p style="font-weight: 600; margin-bottom: 4px;">${p.name}</p>
                  <p style="font-size: 13px; color: #0c5460; margin: 0;">Current stock: ${p.quantity} units ‚Ä¢ Reorder point: ${p.reorder_point}</p>
                </div>
              `).join('')}
            </div>
          `;
        }

        if (critical.length === 0 && high.length === 0 && medium.length === 0) {
          html = `
            <div class="empty-state">
              <div style="font-size: 48px; margin-bottom: 16px;">‚úÖ</div>
              <p style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">All inventory levels are optimal!</p>
              <p style="font-size: 14px; color: #6c757d;">No immediate restocking required. Continue monitoring daily sales.</p>
            </div>
          `;
        }

        container.innerHTML = html;
      } catch (error) {
        console.error('Error loading predictions:', error);
      }
    }

    async function logout() {
      await fetch('/api/logout', { method: 'POST' });
      window.location.href = 'index.html';
    }

    checkAuth();
    loadAnalytics();
  </script>
</body>
</html>